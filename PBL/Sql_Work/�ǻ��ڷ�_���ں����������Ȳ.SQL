SELECT (DAYS(DATE('2002-11-03')) - 
DAYS(DATE(SUBSTRING(WZINPTDT,1,4)||'-'||SUBSTRING(WZINPTDT,5,2)||'-'||SUBSTRING(WZINPTDT,7,2))))
,WZINPTDT FROM PBWIP.WIP090
WHERE WZPLANT = 'B' AND WZCTTP = 'WIPA010';

-- 라인재공 자재데이타 생성
INSERT INTO PBWIP.WIP017
( COMLTD,XPLANT,DIV,ITNO,ORCT,IOCD,
P00,P30,P60,P90,P120,P150,INPTID,INPTDT )
SELECT COMLTD, XPLANT, DIV, ITNO,'9999','1',
  SUM( CASE WHEN (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 30 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P00,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 30 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 60 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P30,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 60 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 90 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P60,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 90 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 120 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P90,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 120 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 150 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P120,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 150 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 365 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P150,'',''
  FROM PBINV.INV401
  WHERE COMLTD = '01' AND SLIPTYPE = 'IS' AND TDTE4 >= '20090601' AND SRCE <> '03' 
      AND CLS IN ('10','40','50')
      AND XUSE IN ('01','02','03','05','06') AND TQTY4 <> 0
  GROUP BY COMLTD, XPLANT, DIV, ITNO;

-- 업체재공 자재데이타 생성
INSERT INTO PBWIP.WIP017
( COMLTD,XPLANT,DIV,ITNO,ORCT,IOCD,
P00,P30,P60,P90,P120,P150,INPTID,INPTDT )
SELECT COMLTD, XPLANT, DIV, ITNO, VSRNO, '2',
  SUM( CASE WHEN (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 30 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P00,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 30 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 60 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P30,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 60 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 90 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P60,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 90 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 120 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P90,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 120 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 150 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P120,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 150 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 365 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P150,'',''
  FROM PBINV.INV401
  WHERE COMLTD = '01' AND SLIPTYPE = 'IS' AND TDTE4 >= '20090601'
      AND CLS IN ('10','40','50')
      AND XUSE = '04' AND TQTY4 <> 0
		  AND SUBSTR(VSRNO,1,1) = 'D'
  GROUP BY COMLTD, XPLANT, DIV, ITNO, VSRNO;

-- 창고재공 자재데이타 생성
INSERT INTO PBWIP.WIP017
( COMLTD,XPLANT,DIV,ITNO,ORCT,IOCD,
P00,P30,P60,P90,P120,P150,INPTID,INPTDT )
SELECT COMLTD, XPLANT, DIV, ITNO, '9999', '3',
  SUM( CASE WHEN (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 30 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P00,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 30 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 60 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P30,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 60 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 90 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P60,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 90 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 120 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P90,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 120 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 150 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P120,
  SUM( CASE WHEN (TDTE4 <= REPLACE(CHAR(DATE('2010-06-30') - 150 DAYS),'-','')) AND
        (TDTE4 > REPLACE(CHAR(DATE('2010-06-30') - 365 DAYS),'-',''))
       THEN TQTY4 ELSE 0 END ) AS P150,'',''
  FROM PBINV.INV401
  WHERE COMLTD = '01' AND SLIPTYPE = 'RP' AND TDTE4 >= '20090601'
      AND SRCE = '04' AND TQTY4 <> 0
  GROUP BY COMLTD, XPLANT, DIV, ITNO;


SELECT A.WBCMCD,A.WBPLANT,A.WBDVSN,A.WBITNO,A.WBPDCD,A.WBDESC,A.WBUNIT,A.WBITCL,A.WBSRCE,A.BGAT,
SUM( CASE WHEN DECIMAL(IFNULL(B.P00,0) * A.WBAVRG1,15,0) >= A.BGAT AND IFNULL(B.P00,0) <> 0 
		THEN A.BGAT ELSE DECIMAL(IFNULL(B.P00,0) * A.WBAVRG1,15,0) END ) AS P00,
SUM( CASE WHEN (A.BGAT - DECIMAL(IFNULL(B.P00,0) * A.WBAVRG1,15,0)) > 0 THEN 
      CASE WHEN DECIMAL(IFNULL(B.P30,0) * A.WBAVRG1,15,0) >= (A.BGAT - DECIMAL(IFNULL(B.P00,0) * A.WBAVRG1,15,0)) 
						AND IFNULL(B.P30,0) <> 0
				THEN (A.BGAT - DECIMAL(IFNULL(B.P00,0) * A.WBAVRG1,15,0))
			  ELSE  DECIMAL(IFNULL(B.P30,0) * A.WBAVRG1,15,0) END
     ELSE 0 END ) AS P30,
SUM( CASE WHEN (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)) * A.WBAVRG1,15,0)) > 0 THEN 
      CASE WHEN DECIMAL(IFNULL(B.P60,0) * A.WBAVRG1,15,0) >= (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)) * A.WBAVRG1,15,0))
						AND IFNULL(B.P60,0) <> 0
				THEN (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)) * A.WBAVRG1,15,0))
			  ELSE  DECIMAL(IFNULL(B.P60,0) * A.WBAVRG1,15,0) END
     ELSE 0 END ) AS P60,
SUM( CASE WHEN (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)+IFNULL(B.P60,0)) * A.WBAVRG1,15,0)) > 0 THEN 
      CASE WHEN DECIMAL(IFNULL(B.P90,0) * A.WBAVRG1,15,0) >= (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)+IFNULL(B.P60,0)) * A.WBAVRG1,15,0))
						AND IFNULL(B.P90,0) <> 0
				THEN (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)+IFNULL(B.P60,0)) * A.WBAVRG1,15,0))
			  ELSE  DECIMAL(IFNULL(B.P90,0) * A.WBAVRG1,15,0) END
     ELSE 0 END ) AS P90,
SUM( CASE WHEN (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)+IFNULL(B.P60,0)+IFNULL(B.P90,0)) * A.WBAVRG1,15,0)) > 0 THEN 
      CASE WHEN DECIMAL(IFNULL(B.P120,0) * A.WBAVRG1,15,0) >= (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)+IFNULL(B.P60,0)+IFNULL(B.P90,0)) * A.WBAVRG1,15,0))
						AND IFNULL(B.P120,0) <> 0
				THEN (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)+IFNULL(B.P60,0)+IFNULL(B.P90,0)) * A.WBAVRG1,15,0))
			  ELSE  DECIMAL(IFNULL(B.P120,0) * A.WBAVRG1,15,0) END
     ELSE 0 END ) AS P120,
SUM( CASE WHEN (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)+IFNULL(B.P60,0)+IFNULL(B.P90,0)+IFNULL(B.P120,0)) * A.WBAVRG1,15,0)) > 0 THEN 
      CASE WHEN DECIMAL(IFNULL(B.P150,0) * A.WBAVRG1,15,0) >= (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)+IFNULL(B.P60,0)+IFNULL(B.P90,0)+IFNULL(B.P120,0)) * A.WBAVRG1,15,0))
						AND IFNULL(B.P150,0) <> 0
				THEN (A.BGAT - DECIMAL((IFNULL(B.P00,0)+IFNULL(B.P30,0)+IFNULL(B.P60,0)+IFNULL(B.P90,0)+IFNULL(B.P120,0)) * A.WBAVRG1,15,0))
			  ELSE  DECIMAL(IFNULL(B.P150,0) * A.WBAVRG1,15,0) END
     ELSE 0 END ) AS P150
FROM
( SELECT WBCMCD,WBPLANT,WBDVSN,WBPDCD,WBITNO,WBAVRG1,WBDESC,WBSPEC,WBITCL,WBSRCE,WBUNIT,(WBBGQT + WBINQT -
  ( WBUSQT1 + WBUSQT2 + WBUSQT3 + WBUSQT4 + WBUSQT5 + WBUSQT6 + WBUSQT7 + WBUSQT8 + WBUSQTA)) AS BGQT,
  (WBBGAT1 + WBINAT1 + WBINAT2 + WBINAT3 - 
  (WBUSAT1 + WBUSAT2 + WBUSAT3 + WBUSAT4 + WBUSAT5 + WBUSAT6 + WBUSAT7 + WBUSAT8 + WBUSAT9 + WBUSATA)) AS BGAT
 FROM PBWIP.WIP002
 WHERE WBCMCD = '01' AND WBYEAR = '2010' AND WBMONTH = '06' AND WBIOCD = '1' ) A
LEFT OUTER JOIN PBWIP.WIP017 B
ON A.WBCMCD = B.COMLTD AND A.WBPLANT = B.XPLANT AND
   A.WBDVSN = B.DIV AND A.WBITNO = B.ITNO
WHERE A.BGAT <> 0
GROUP BY A.WBCMCD,A.WBPLANT,A.WBDVSN,A.WBITNO,A.WBPDCD,A.WBDESC,A.WBUNIT,A.WBITCL,A.WBSRCE,A.BGAT;


-- 업체조건
AND SLIPTYPE IN ('IS','RS','IP') AND CLS IN ('10','40','50')
      AND XUSE = '04'
		AND SUBSTR(VSRNO,1,1) = 'D' AND TQTY4 <> 0

-- 라인조건
AND SLIPTYPE IN ('IS','RS','IP') AND CLS IN ('10','40','50')
      AND SRCE <> '03' AND XUSE IN ('01','02','03','05','06') AND TQTY4 <> 0
      
-- 창고
AND (SLIPTYPE = 'RP' AND SRCE = '04' AND TQTY4 <> 0)
