//SELECT * FROM PBBPM.BPM106
//WHERE COMLTD = '01' AND AYEAR = '2009' AND ACODE = 'A' AND APLANT = 'D' AND ADIV = 'A' 
//ORDER BY AMDNO, ADECD
//;

SELECT * FROM PBBPM.BPM107
WHERE COMLTD = '01' AND MYEAR = '2009' AND MPLANT = 'D' AND MDIV = 'A' AND MMDNO = '17201253';

//SELECT * FROM PBINV.INV101
//WHERE COMLTD = '01' AND ITNO = '17201253';


SELECT TMP.APLANT,TMP.ADIV,TMP.AMDNO,TMP.ADECD,
-- 내자 금액계산 
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = '' OR TMP.YCURD = 'WON' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDWON,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'USD' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDUSD,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'JPY' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDJPY,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'DEM' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDDEM,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'FRF' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDFRF,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'GBP' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDGBP,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'AUD' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDAUD,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'ESP' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDESP,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'EUR' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDEUR,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'ITL' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDITL,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'CHF' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDCHF,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'BFR' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDBFR,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'DKK' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDDKK,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'ATS' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDATS,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'CAD' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDCAD,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'SEK' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDSEK,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'RMB' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDRMB,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE <> '01' THEN
			CASE WHEN TMP.YCURD = 'FIM' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MDFIM,
--외자재료비 계산
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'USD' THEN 
				CASE WHEN TMP.ADECD = 'D' THEN TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT
 				ELSE TMP.CURECST * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT END
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIUSD,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'JPY' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIJPY,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'DEM' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIDEM,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'FRF' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIFRF,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'GBP' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIGBP,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'AUD' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIAUD,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'ESP' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIESP,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'EUR' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIEUR,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'ITL' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIITL,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'CHF' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MICHF,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'BFR' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIBFR,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'DKK' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIDKK,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'ATS' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIATS,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'CAD' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MICAD,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'SEK' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MISEK,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'RMB' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIRMB,
SUM( DECIMAL(CASE WHEN TMP.BWOCT <> '8888' AND TMP.BYOU <> '*' AND TMP.SRCE = '01' THEN
			CASE WHEN TMP.YCURE = 'FIM' THEN 
				TMP.YCSTE01 * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT
			ELSE 0 END
		ELSE 0 END,15,6) ) AS MIFIM
FROM ( SELECT AA.APLANT,AA.ADIV,AA.AMDNO,AA.ADECD,BB.COMLTD,BB.BPLANT,BB.BDIV,
BB.BMDNO,BB.BSERNO,BB.BPRNO,BB.BCHNO,
BB.BWOCT,BB.BYOU,BB.BPRQT,DD.SRCE,CC.YVNDSR,CC.YPLAN,
CC.YCURD,CC.YCURE,CC.YCSTD0,CC.YCSTE0,CC.YCSTD01,CC.YCSTE01,
-- 내자환율 적용
CASE WHEN DD.SRCE = '01' THEN CC.YCURE 
ELSE ( CASE WHEN CC.YCSTD01 = 0 THEN '' ELSE CC.YCURD END ) END AS CURD,
-- 외자환율 적용
CASE WHEN DD.SRCE <> '01' THEN 
     ( CASE WHEN CC.YCSTE01 = 0 THEN '' ELSE CC.YCURE END ) 
ELSE CC.YCURE END AS CURE,
-- 외자적용기준단가
CASE WHEN DD.CLS = '10' OR DD.CLS = '20' OR DD.CLS = '40' OR DD.CLS = '50' AND DD.CLS = '35' THEN
	CASE WHEN ( DD.SRCE = '03' OR DD.SRCE = '05' OR DD.SRCE = '06' ) OR DD.CLS = '30' THEN 0
   ELSE CASE WHEN DD.SRCE <> '01' THEN 
          CASE WHEN CC.YCSTE01 = 0 THEN CC.YCSTD01 ELSE CC.YCSTE01 END
        ELSE CC.YCSTE01 END 
   END
ELSE 0 END AS CURECST,
-- 내자적용기준단가
CASE WHEN DD.CLS = '10' OR DD.CLS = '20' OR DD.CLS = '40' OR DD.CLS = '50' AND DD.CLS = '35' THEN
	CASE WHEN ( DD.SRCE = '03' OR DD.SRCE = '05' OR DD.SRCE = '06' ) OR DD.CLS = '30' THEN 0
   ELSE CASE WHEN DD.SRCE <> '01' THEN 
          CASE WHEN CC.YCSTD01 = 0 THEN CC.YCSTE01 ELSE CC.YCSTD01 END
        ELSE CC.YCSTD01 END 
   END
ELSE 0 END AS CURDCST,
-- 변환계수
CASE WHEN DD.SRCE = '01' THEN ( CASE WHEN BB.BUM = CC.YUNIT THEN 1 
  ELSE ( SELECT UUMCV FROM PBBPM.BPM105 
	WHERE COMLTD = '01' AND UYEAR = '2009' AND UPLANT = BB.BPLANT AND UDIV = BB.BDIV AND
		UITNO = BB.BCHNO AND UUNIT1 = BB.BUM AND UUNIT2 = CC.YUNIT ) END )
ELSE DD.CONVQTY END AS CONV_FACTOR,
-- 외자환율
CASE WHEN CC.YCURE <> '' AND CC.YCURE <> 'KRW' THEN
   ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURE )
ELSE 1 END AS WKEXCE,
-- 내자환율
CASE WHEN DD.SRCE = '01' THEN
	CASE WHEN CC.YCURE <> '' AND CC.YCURE <> 'WON' THEN
   ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURE )
   ELSE 1 END 
ELSE
   CASE WHEN CC.YCURD <> '' AND CC.YCURD <> 'WON' THEN
   ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURD)
   ELSE 1 END 
END AS WKEXCD
FROM ( SELECT DISTINCT COMLTD,APLANT,ADIV,APDCD,AMDNO,ADECD FROM PBBPM.BPM106
WHERE COMLTD = '01' AND AYEAR = '2009' AND AMDNO = '17201253' AND ACODE = 'A' ) AA
INNER JOIN PBBPM.BPM101 BB
ON AA.COMLTD = BB.COMLTD AND AA.APLANT = BB.BPLANT AND AA.ADIV = BB.BDIV AND
	AA.AMDNO = BB.BMDNO
LEFT OUTER JOIN PBBPM.BPM102 DD
ON BB.COMLTD = DD.COMLTD AND BB.BPLANT = DD.XPLANT AND BB.BDIV = DD.DIV AND BB.BCHNO = DD.ITNO
LEFT OUTER JOIN ( SELECT COMLTD,YPLANT,YDIV,YITNO,YVNDSR,YPLAN,YCURD,YCURE,
	YSRCE,YUNIT,YCSTD0,YCSTE0,YCSTD01,YCSTE01
FROM PBBPM.BPM103
WHERE COMLTD = '01' AND YCCYY = '2009') CC
ON BB.COMLTD = CC.COMLTD AND BB.BPLANT = CC.YPLANT AND BB.BDIV = CC.YDIV AND BB.BCHNO = CC.YITNO
ORDER BY AA.APLANT,AA.ADIV,AA.AMDNO,AA.ADECD,BB.BSERNO ) TMP
GROUP BY TMP.APLANT,TMP.ADIV,TMP.AMDNO,TMP.ADECD;