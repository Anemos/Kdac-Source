SELECT TMP.COMLTD,'2010',TMP.APLANT,TMP.ADIV,TMP.APDCD,TMP.AMDNO,AA.SEQGB,AA.ADECD,0,
-- COSTDOWN 처리
-- 1월
CASE WHEN TMP.CLS = '40' OR TMP.CLS = '50' THEN 0
ELSE 
  CASE WHEN (TMP.CURECST - ( CASE WHEN TMP.SRCE = '01' THEN
     BB.YCSTE11
     ELSE
       CASE WHEN BB.YCSTE11 = 0 THEN BB.YCSTD11 ELSE BB.YCSTE11 END
     END )) > 0 THEN 
         (TMP.CURECST - ( CASE WHEN TMP.SRCE = '01' THEN
           BB.YCSTE11
          ELSE
           CASE WHEN BB.YCSTE11 = 0 THEN BB.YCSTD11 ELSE BB.YCSTE11 END
          END ))
  ELSE 0 END
END  AS MDCST1,
CASE WHEN TMP.CLS = '40' OR TMP.CLS = '50' THEN 0
ELSE 
  CASE WHEN BB.YCHGE = '3' THEN 
  CASE WHEN (TMP.CURECST - ( CASE WHEN TMP.SRCE = '01' THEN
     BB.YCSTE11
     ELSE
       CASE WHEN BB.YCSTE11 = 0 THEN BB.YCSTD11 ELSE BB.YCSTE11 END
     END )) > 0 THEN 
         (TMP.CURECST - ( CASE WHEN TMP.SRCE = '01' THEN
           BB.YCSTE11
          ELSE
           CASE WHEN BB.YCSTE11 = 0 THEN BB.YCSTD11 ELSE BB.YCSTE11 END
          END ))
  ELSE 0 END
  ELSE 0 END
END  * TMP.WKEXCE / TMP.CONV_FACTOR * TMP.BPRQT AS MDSRC1,
( TMP.CURDCST - ( CASE WHEN TMP.SRCE = '01' THEN
  BB.YCSTD11
ELSE
  CASE WHEN BB.YCSTD11 = 0 THEN BB.YCSTE11 ELSE BB.YCSTD11 END
END ))  * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT AS CDDOMAMT11

-- COSTDOWN 처리
-- 1월
CASE WHEN TMP.CLS = '40' OR TMP.CLS = '50' THEN 0
ELSE 
  CASE WHEN (TMP.CURECST - 
   ( CASE WHEN TMP.SRCE = '01' THEN BB.YCSTE11
     ELSE
       CASE WHEN BB.YCSTE11 = 0 THEN BB.YCSTD11 ELSE BB.YCSTE11 END
     END )) > 0 THEN 
         (TMP.CURECST - ( CASE WHEN TMP.SRCE = '01' THEN
           BB.YCSTE11
          ELSE
           CASE WHEN BB.YCSTE11 = 0 THEN BB.YCSTD11 ELSE BB.YCSTE11 END
          END ))
  ELSE 0 END
END  AS CDEXPCST11,
CASE WHEN TMP.CLS = '40' OR TMP.CLS = '50' THEN 0
ELSE 
  CASE WHEN (
  TMP.CURDCST - 
   ( CASE WHEN TMP.SRCE = '01' THEN BB.YCSTD11
     ELSE
       CASE WHEN BB.YCSTD11 = 0 THEN BB.YCSTE11 ELSE BB.YCSTD11 END
     END )) > 0 THEN 
         (TMP.CURDCST - ( CASE WHEN TMP.SRCE = '01' THEN
           BB.YCSTD11
          ELSE
           CASE WHEN BB.YCSTD11 = 0 THEN BB.YCSTE11 ELSE BB.YCSTD11 END
          END ))
  ELSE 0 END
END  AS CDDOMCST11


FROM ( SELECT DISTINCT COMLTD,AYEAR,APLANT,ADIV,APDCD,AMDNO,'E' AS ADECD,SEQGB FROM PBBPM.BPM106
WHERE COMLTD = '01' AND AYEAR = '2009' AND APLANT = 'D' AND ADIV = 'A' AND ACODE = 'A' AND AMDNO = '17201253') AA
INNER JOIN PBBPM.BPM413 TMP
ON AA.COMLTD = TMP.COMLTD AND AA.APLANT = TMP.BPLANT AND AA.ADIV = TMP.BDIV AND
	AA.AMDNO = TMP.BMDNO AND AA.AYEAR = TMP.AYEAR
INNER JOIN PBBPM.BPM103 BB
ON  BB.COMLTD = TMP.COMLTD AND BB.YCCYY = TMP.AYEAR AND
  BB.YPLANT = TMP.BPLANT AND BB.YDIV = TMP.BDIV AND 
  BB.YVNDSR = TMP.YVNDSR AND BB.YITNO = TMP.BCHNO AND BB.YGRAD = '1'
ORDER BY TMP.COMLTD,TMP.APLANT,TMP.ADIV,TMP.APDCD,TMP.AMDNO,AA.SEQGB,AA.ADECD;


           MOVE RCSTE1(I-IDX) TO WK-CDCURECST.
           MOVE RCSTD1(I-IDX) TO WK-CDCURDCST.
           IF SRCE OF BPM102-REC = "01"
              MOVE RCSTE1(I-IDX) TO WK-CDCURECST
              MOVE RCSTD1(I-IDX) TO WK-CDCURDCST
           ELSE
              IF RCSTE1(I-IDX) = ZEROS
                 MOVE RCSTD1(I-IDX) TO WK-CDCURECST
              ELSE
                 IF RCSTD1(I-IDX) = ZEROS
                    MOVE RCSTE1(I-IDX) TO WK-CDCURDCST.
           DIVIDE WK-IUMCV INTO WK-CDCURECST GIVING WK-CDCURECST.
           DIVIDE WK-IUMCV INTO WK-CDCURDCST GIVING WK-CDCURDCST.
           IF RDMONTH = SPACE
              NEXT SENTENCE
           ELSE
              MOVE RDMONTH TO WK-MONTH1.
           IF RDMONTH = SPACE
              SUBTRACT WK-CDCURECST FROM WK-CURECST GIVING WK-CDCURECST
              SUBTRACT WK-CDCURDCST FROM WK-CURDCST GIVING WK-CDCURDCST
              IF SRCE OF BPM102-REC = "01"
               MULTIPLY WK-CDCURECST BY   WK-EXCE    GIVING WK-CDEXPCST
               MULTIPLY WK-CDCURDCST BY   WK-EXCD    GIVING WK-CDDOMCST
              ELSE
               MOVE WK-CDCURECST TO WK-CDEXPCST
               MOVE WK-CDCURDCST TO WK-CDDOMCST
           ELSE
           IF RPERD(I-IDX) = ZEROS
            SUBTRACT WK-CDCURDCST FROM WK-CURDCST GIVING WK-CDCURDCST
            MULTIPLY WK-CDCURDCST BY   WK-EXCD    GIVING WK-CDDOMCST
            IF RPERE(I-IDX) = ZEROS
              SUBTRACT WK-CDCURECST FROM WK-CURECST GIVING WK-CDCURECST
              MULTIPLY WK-CDCURECST BY   WK-EXCE    GIVING WK-CDEXPCST
            ELSE
              SUBTRACT WK-CDCURECST FROM WK-EXPCST GIVING WK-CDEXPCST
           ELSE
            SUBTRACT WK-CDCURDCST FROM WK-DOMCST GIVING WK-CDDOMCST
            IF RPERE(I-IDX) = ZEROS
              SUBTRACT WK-CDCURECST FROM WK-CURECST GIVING WK-CDCURECST
              MULTIPLY WK-CDCURECST BY   WK-EXCE    GIVING WK-CDEXPCST
            ELSE
              SUBTRACT WK-CDCURECST FROM WK-EXPCST GIVING WK-CDEXPCST.
           MULTIPLY WK-CDEXPCST  BY   S-QTY GIVING WK-CDEXPAMT ROUNDED.
           MULTIPLY WK-CDDOMCST  BY   S-QTY GIVING WK-CDDOMAMT ROUNDED.
           
           
SELECT AA.COMLTD,AA.AYEAR,AA.APLANT,AA.ADIV,AA.APDCD,AA.AMDNO,
BB.BPLANT,BB.BDIV,BB.BMDNO,BB.BSERNO,BB.BPRNO,BB.BCHNO,BB.BWOCT,BB.BPRQT,BB.BYOU,DD.SRCE,DD.CLS,
IFNULL(CC.YVNDSR,''),IFNULL(CC.YPLAN,''),IFNULL(CC.YCURD,''),IFNULL(CC.YCURE,''),
IFNULL(CC.YCSTD0,0),IFNULL(CC.YCSTE0,0),IFNULL(CC.YCSTD01,0),IFNULL(CC.YCSTE01,0),
-- 내자환율 적용
IFNULL(CASE WHEN DD.SRCE = '01' THEN 
  ( CASE WHEN CC.YCURE = '' THEN '10' 
    ELSE (SELECT IFNULL(DD.SEQNO,'99') FROM PBBPM.BPM412 DD WHERE DD.COMLTD = '01' AND DD.CURUNIT = CC.YCURE) 
    END )
ELSE 
  ( CASE WHEN CC.YCSTD01 = 0 THEN 
     '10' 
    ELSE 
     ( CASE WHEN CC.YCURD = '' THEN 
        '10' 
       ELSE (SELECT IFNULL(DD.SEQNO,'99') FROM PBBPM.BPM412 DD WHERE DD.COMLTD = '01' AND DD.CURUNIT = CC.YCURD) 
		 END) 
    END ) 
END,'10') AS CURD_NO,
-- 외자환율 적용
IFNULL(CASE WHEN DD.SRCE <> '01' THEN 
     ( CASE WHEN CC.YCSTE01 = 0 THEN 
			'10'
		 ELSE (SELECT IFNULL(DD.SEQNO,'99') FROM PBBPM.BPM412 DD WHERE DD.COMLTD = '01' AND DD.CURUNIT = CC.YCURE) 
		 END ) 
ELSE (SELECT IFNULL(DD.SEQNO,'99') FROM PBBPM.BPM412 DD WHERE DD.COMLTD = '01' AND DD.CURUNIT = CC.YCURE) 
END,'10') AS CURE_NO,
-- 내자적용기준단가
IFNULL(CASE WHEN DD.CLS = '10' OR DD.CLS = '20' OR DD.CLS = '40' OR DD.CLS = '50' OR DD.CLS = '35' THEN
	CASE WHEN ( DD.SRCE = '03' OR DD.SRCE = '05' OR DD.SRCE = '06' ) OR DD.CLS = '30' THEN 
	  0
  ELSE 
    CASE WHEN DD.SRCE <> '01' THEN 
      CASE WHEN CC.YCSTE01 = 0 THEN 
        CC.YCSTD01 
      ELSE 
        CASE WHEN CC.YCSTD01 = 0 THEN CC.YCSTE01 ELSE CC.YCSTD01 END
      END
    ELSE CC.YCSTD01 END 
  END
ELSE 0 END,0) AS CURDCST,
-- 외자적용기준단가
IFNULL(CASE WHEN DD.CLS = '10' OR DD.CLS = '20' OR DD.CLS = '40' OR DD.CLS = '50' AND DD.CLS = '35' THEN
	CASE WHEN ( DD.SRCE = '03' OR DD.SRCE = '05' OR DD.SRCE = '06' ) OR DD.CLS = '30' THEN 0
   ELSE CASE WHEN DD.SRCE <> '01' THEN 
          CASE WHEN CC.YCSTE01 = 0 THEN CC.YCSTD01 ELSE CC.YCSTE01 END
        ELSE CC.YCSTE01 END 
   END
ELSE 0 END,0) AS CURECST,
-- 변환계수
IFNULL(CASE WHEN DD.SRCE = '01' THEN ( CASE WHEN BB.BUM = CC.YUNIT THEN 1 
  ELSE ( SELECT UUMCV FROM PBBPM.BPM105 
	WHERE COMLTD = '01' AND UYEAR = '2009' AND UPLANT = BB.BPLANT AND UDIV = BB.BDIV AND
		UITNO = BB.BCHNO AND UUNIT1 = BB.BUM AND UUNIT2 = CC.YUNIT ) END )
ELSE DD.CONVQTY END,1) AS CONV_FACTOR,
-- 내자환율
IFNULL(CASE WHEN DD.SRCE = '01' THEN
	CASE WHEN CC.YCURE <> '' AND CC.YCURE <> 'WON' THEN
   ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURE )
   ELSE 1 END 
ELSE
   CASE WHEN CC.YCURD <> '' AND CC.YCURD <> 'WON' THEN
   ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURD)
   ELSE 1 END 
END,1) AS WKEXCD,
-- 외자환율
IFNULL(CASE WHEN CC.YCURE <> '' AND CC.YCURE <> 'KRW' THEN
   ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURE )
ELSE 1 END,1) AS WKEXCE
-- 1월
CASE WHEN DD.SRCE = '01' THEN
  CC.YCSTE11
ELSE
  CASE WHEN CC.YCSTE11 = 0 THEN CC.YCSTD11 ELSE CC.YCSTE11 END
END AS CDEXPAMT11,
CASE WHEN DD.SRCE = '01' THEN
  CC.YCSTD11
ELSE
  CASE WHEN CC.YCSTD11 = 0 THEN CC.YCSTE11 ELSE CC.YCSTD11 END
END AS CDDOMAMT11
FROM ( SELECT DISTINCT COMLTD,AYEAR,APLANT,ADIV,APDCD,AMDNO FROM PBBPM.BPM106
WHERE COMLTD = '01' AND AYEAR = '2009' AND APLANT = 'D' AND ADIV = 'A' AND ACODE = 'A') AA
INNER JOIN PBBPM.BPM101 BB
ON AA.COMLTD = BB.COMLTD AND AA.APLANT = BB.BPLANT AND AA.ADIV = BB.BDIV AND
	AA.AMDNO = BB.BMDNO
LEFT OUTER JOIN PBBPM.BPM102 DD
ON BB.COMLTD = DD.COMLTD AND BB.BPLANT = DD.XPLANT AND BB.BDIV = DD.DIV AND BB.BCHNO = DD.ITNO
LEFT OUTER JOIN ( SELECT COMLTD,YPLANT,YDIV,YITNO,YVNDSR,YPLAN,YCURD,YCURE,
	YSRCE,YUNIT,YCSTD0,YCSTE0,YCSTD01,YCSTE01
FROM PBBPM.BPM103
WHERE COMLTD = '01' AND YCCYY = '2009' AND YGRAD = '1') CC
ON BB.COMLTD = CC.COMLTD AND BB.BPLANT = CC.YPLANT AND BB.BDIV = CC.YDIV AND BB.BCHNO = CC.YITNO
;