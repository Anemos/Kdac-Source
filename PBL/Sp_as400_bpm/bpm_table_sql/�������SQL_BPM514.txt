-- 재료비생성 중간단계 (create bpm514)
INSERT INTO PBBPM.BPM514
( ZCMCD,ZDATE,ZBREV,ZGUBUN,ZPLANT,ZDIV,ZMDCD,
ZMDNO,ZSERIAL,ZLEVEL,ZITNO,ZREV,ZDESC,ZSPEC,ZUNITQTY,
ZUNIT1,ZCONFACT,ZUNIT2,ZSRCE,ZTYPE,
ZCURD,ZCURE,ZFOB1,ZFOB2,ZCHK,
ZCURDCST,ZCURECST,ZWONDCST,ZWONECST,ZWONDAMT,ZWONEAMT,
ZWKCT,ZGRAD,ZALTNO,ZFMDT,ZTODT,ZCALC )

SELECT BB.COMLTD,BB.XYEAR,AA.AREV,AA.ACODE,AA.APLANT,AA.ADIV,AA.APDCD,
AA.AMDNO,BB.BSERNO,BB.BLEV,BB.BCHNO,'',EE.ITNM,EE.SPEC,BB.BPRQT,
BB.BUM,IFNULL(CC.CONVQTY,1),IFNULL(CC.XUNIT1,EE.XUNIT),DD.SRCE,EE.XTYPE,
IFNULL(CC.YCURR,''),IFNULL(CC.YCURR,''),IFNULL(CC.YCODE,''),'','',
DECIMAL(IFNULL(CC.YCSTR,0),14,6),
DECIMAL(IFNULL(CC.YCSTR,0),14,6),
TRUNCATE(IFNULL(CC.YCSTD / IFNULL(CC.CONVQTY,1) * CASE WHEN CC.YCURR <> '' AND CC.YCURR <> 'KRW' THEN
          ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURR )
          ELSE 1 END,0),2),
TRUNCATE(IFNULL(CC.YCSTE / IFNULL(CC.CONVQTY,1) * CASE WHEN CC.YCURR <> '' AND CC.YCURR <> 'KRW' THEN
          ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURR )
          ELSE 1 END,0),2),
TRUNCATE(IFNULL(CC.YCSTD * CASE WHEN CC.YCURR <> '' AND CC.YCURR <> 'KRW' THEN
          ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURR )
          ELSE 1 END * BB.BPRQT / IFNULL(CC.CONVQTY,1),0),3),
TRUNCATE(IFNULL(CC.YCSTE * CASE WHEN CC.YCURR <> '' AND CC.YCURR <> 'KRW' THEN
          ( SELECT CEXC FROM PBBPM.BPM104 WHERE COMLTD = '01' AND CYEAR = '2009' AND CCUR = CC.YCURR )
          ELSE 1 END * BB.BPRQT / IFNULL(CC.CONVQTY,1),0),3),      
BB.BWOCT,BB.BGRAD,BB.BALTNO,BB.BFMDT,BB.BTODT,BB.BCALC
FROM ( SELECT DISTINCT COMLTD,AYEAR,ACODE,AREV,APLANT,ADIV,APDCD,AMDNO FROM PBBPM.BPM501
WHERE COMLTD = '01' AND AYEAR = '2009' AND APLANT = 'D' AND ADIV = 'A' AND ACODE = 'A' AND AREV = '0A') AA
INNER JOIN PBBPM.BPM508 BB
ON AA.COMLTD = BB.COMLTD AND AA.AYEAR = BB.XYEAR AND
  AA.APLANT = BB.BPLANT AND AA.ADIV = BB.BDIV AND
	AA.AMDNO = BB.BMDNO AND AA.ACODE = BB.BGUBUN AND
	AA.AREV = BB.BREV
INNER JOIN PBBPM.BPM503 DD
ON BB.XYEAR = DD.XYEAR AND BB.BPLANT = DD.XPLANT AND BB.BDIV = DD.DIV AND BB.BCHNO = DD.ITNO
INNER JOIN PBBPM.BPM502 EE
ON DD.XYEAR = EE.XYEAR AND DD.ITNO = EE.ITNO
LEFT OUTER JOIN PBBPM.BPM509 CC
ON BB.BCHNO = CC.YITNO AND BB.XYEAR = CC.YCCYY AND
  CC.YGUBUN = '10' AND CC.YGRAD = '1'
ORDER BY AA.APLANT,AA.ADIV,AA.AMDNO,BB.BSERNO;

-- 히스토리 단가체크
SELECT 'A',ZSERIAL,ZITNO,ZSRCE,ZUNITQTY,ZUNIT1,ZCONFACT,ZUNIT2,ZSRCE,ZCHK,
CAST(CASE WHEN ZCURDCST = '' THEN '0' ELSE REPLACE(ZCURDCST,',','') END AS DECIMAL(15,6)),
CAST(CASE WHEN ZCURECST = '' THEN '0' ELSE REPLACE(ZCURECST,',','') END AS DECIMAL(15,6)),
CAST(CASE WHEN ZWONDCST = '' THEN '0' ELSE REPLACE(ZWONDCST,',','') END AS DECIMAL(15,6)),
CAST(CASE WHEN ZWONECST = '' THEN '0' ELSE REPLACE(ZWONECST,',','') END AS DECIMAL(15,6)),
CAST(CASE WHEN ZWONEAMT = '' THEN '0' ELSE REPLACE(ZWONEAMT,',','') END AS DECIMAL(15,6)),
CAST(CASE WHEN ZWONDAMT = '' THEN '0' ELSE REPLACE(ZWONDAMT,',','') END AS DECIMAL(15,6))
FROM PBBPM.BPM013
WHERE ZGUBUN = 'A' AND ZMDNO = '28153185'
UNION ALL
SELECT 'B',ZSERIAL,ZITNO,ZSRCE,ZUNITQTY,ZUNIT1,ZCONFACT,ZUNIT2,ZSRCE,ZCHK,ZCURDCST,ZCURECST,
ZWONDCST,ZWONECST,ZWONEAMT,ZWONDAMT FROM PBBPM.BPM514
WHERE ZGUBUN = 'A' AND ZMDNO = '28153185'
ORDER BY ZSERIAL,ZITNO;

-- 매출품목 품목기본정보 미등록
INSERT INTO PBBPM.BPM512
( CHGDATE,XYEAR,ERRGUBUN,
ERRMDNO,ERRITNO,ERRPLANT,ERRDIV,ERRVNDSR,ERRCUR,
ERRUNIT1,ERRUNIT2,ERRCHGE,ERRPLAN,ERRCONFIRM,UPDTID )
SELECT CHAR(CURRENT TIMESTAMP), AA.AYEAR,'매출제품 품목기본정보 미등록',
AA.AMDNO,'',AA.APLANT,AA.ADIV,'','',
'','','','','N',''
FROM (SELECT DISTINCT COMLTD,AYEAR,ACODE,AREV,APLANT,ADIV,APDCD,AMDNO,ADECD FROM PBBPM.BPM501
  WHERE COMLTD = '01' AND AYEAR = '2009' AND APLANT = 'D' AND 
    ADIV = 'A' AND ACODE = 'A' AND AREV = '0A' ) AA
WHERE NOT EXISTS ( SELECT * FROM PBBPM.BPM502 DD
      WHERE AA.AYEAR = DD.XYEAR AND AA.AMDNO = DD.ITNO )
            
-- 매출품목 품목상세정보 미등록
INSERT INTO PBBPM.BPM512
( CHGDATE,XYEAR,ERRGUBUN,
ERRMDNO,ERRITNO,ERRPLANT,ERRDIV,ERRVNDSR,ERRCUR,
ERRUNIT1,ERRUNIT2,ERRCHGE,ERRPLAN,ERRCONFIRM,UPDTID )
SELECT CHAR(CURRENT TIMESTAMP), AA.AYEAR,'매출제품 품목상세정보 미등록',
AA.AMDNO,'',AA.APLANT,AA.ADIV,'','',
'','','','','N',''
FROM (SELECT DISTINCT COMLTD,AYEAR,ACODE,AREV,APLANT,ADIV,APDCD,AMDNO,ADECD FROM PBBPM.BPM501
  WHERE COMLTD = '01' AND AYEAR = '2009' AND APLANT = 'D' AND 
    ADIV = 'A' AND ACODE = 'A' AND AREV = '0A' ) AA
WHERE NOT EXISTS ( SELECT * FROM PBBPM.BPM503 DD
      WHERE AA.AYEAR = DD.XYEAR AND AA.APLANT = DD.XPLANT AND 
            AA.ADIV = DD.DIV AND AA.AMDNO = DD.ITNO )
            
-- 원단위품 품목상세정보 미등록
INSERT INTO PBBPM.BPM512
( CHGDATE,XYEAR,ERRGUBUN,
ERRMDNO,ERRITNO,ERRPLANT,ERRDIV,ERRVNDSR,ERRCUR,
ERRUNIT1,ERRUNIT2,ERRCHGE,ERRPLAN,ERRCONFIRM,UPDTID )
SELECT CHAR(CURRENT TIMESTAMP), BB.XYEAR,'원단위품 품목상세정보 미등록',
BB.BMDNO,BB.BCHNO,BB.BPLANT,BB.BDIV,'','',
'','','','','N',''
FROM (SELECT DISTINCT COMLTD,AYEAR,ACODE,AREV,APLANT,ADIV,APDCD,AMDNO,ADECD FROM PBBPM.BPM501
  WHERE COMLTD = '01' AND AYEAR = '2009' AND APLANT = 'D' AND 
    ADIV = 'A' AND ACODE = 'A' AND AREV = '0A' ) AA
INNER JOIN PBBPM.BPM508 BB
ON AA.COMLTD = BB.COMLTD AND AA.AYEAR = BB.XYEAR AND
  AA.APLANT = BB.BPLANT AND AA.ADIV = BB.BDIV AND
	AA.AMDNO = BB.BMDNO AND AA.ACODE = BB.BGUBUN AND AA.AREV = BB.BREV
WHERE NOT EXISTS ( SELECT * FROM PBBPM.BPM503 DD
      WHERE BB.XYEAR = DD.XYEAR AND BB.BPLANT = DD.XPLANT AND 
            BB.BDIV = DD.DIV AND BB.BCHNO = DD.ITNO )
            
-- 원단위품 단가정보 미등록
INSERT INTO PBBPM.BPM512
( CHGDATE,XYEAR,ERRGUBUN,
ERRMDNO,ERRITNO,ERRPLANT,ERRDIV,ERRVNDSR,ERRCUR,
ERRUNIT1,ERRUNIT2,ERRCHGE,ERRPLAN,ERRCONFIRM,UPDTID )
SELECT CHAR(CURRENT TIMESTAMP), BB.XYEAR,'원단위품 단가정보 미등록',
BB.BMDNO,BB.BCHNO,BB.BPLANT,BB.BDIV,'','',
'','','','','N',''
FROM (SELECT DISTINCT COMLTD,AYEAR,ACODE,AREV,APLANT,ADIV,APDCD,AMDNO,ADECD FROM PBBPM.BPM501
  WHERE COMLTD = '01' AND AYEAR = '2009' AND APLANT = 'D' AND 
    ADIV = 'A' AND ACODE = 'A' AND AREV = '0A' ) AA
INNER JOIN PBBPM.BPM508 BB
ON AA.COMLTD = BB.COMLTD AND AA.AYEAR = BB.XYEAR AND
  AA.APLANT = BB.BPLANT AND AA.ADIV = BB.BDIV AND
	AA.AMDNO = BB.BMDNO AND AA.ACODE = BB.BGUBUN AND AA.AREV = BB.BREV
WHERE NOT EXISTS ( SELECT * FROM PBBPM.BPM509 CC
    WHERE CC.YCCYY = BB.XYEAR AND CC.YPLANT = BB.BPLANT AND
          CC.YDIV = BB.BDIV AND CC.YITNO = BB.BCHNO AND
          CC.YGRAD = '1' );
          
-- 단가정보 0인 품목
INSERT INTO PBBPM.BPM512
( CHGDATE,XYEAR,ERRGUBUN,
ERRMDNO,ERRITNO,ERRPLANT,ERRDIV,ERRVNDSR,ERRCUR,
ERRUNIT1,ERRUNIT2,ERRCHGE,ERRPLAN,ERRCONFIRM,UPDTID )
SELECT CHAR(CURRENT TIMESTAMP), BB.XYEAR,'단가정보 0인 품목',
BB.BMDNO,BB.BCHNO,BB.BPLANT,BB.BDIV,CC.YVNDSR,CC.YCURR,
CC.XUNIT,CC.XUNIT1,CC.YCHGE,CC.YPLAN,'N',''
FROM (SELECT DISTINCT COMLTD,AYEAR,ACODE,AREV,APLANT,ADIV,APDCD,AMDNO,ADECD FROM PBBPM.BPM501
  WHERE COMLTD = '01' AND AYEAR = '2009' AND APLANT = 'D' AND 
    ADIV = 'A' AND ACODE = 'A' AND AREV = '0A' ) AA
INNER JOIN PBBPM.BPM508 BB
ON AA.COMLTD = BB.COMLTD AND AA.AYEAR = BB.XYEAR AND
  AA.APLANT = BB.BPLANT AND AA.ADIV = BB.BDIV AND
	AA.AMDNO = BB.BMDNO AND AA.ACODE = BB.BGUBUN AND AA.AREV = BB.BREV
INNER JOIN PBBPM.BPM503 DD
ON BB.XYEAR = DD.XYEAR AND BB.BPLANT = DD.XPLANT AND BB.BDIV = DD.DIV AND BB.BCHNO = DD.ITNO
INNER JOIN PBBPM.BPM503 DD
ON BB.XYEAR = DD.XYEAR AND BB.BPLANT = DD.XPLANT AND BB.BDIV = DD.DIV AND BB.BCHNO = DD.ITNO
INNER JOIN PBBPM.BPM509 CC
ON BB.BPLANT = CC.YPLANT AND BB.BDIV = CC.YDIV AND 
  BB.BCHNO = CC.YITNO AND BB.XYEAR = CC.YCCYY AND
  CC.YGRAD = '1'
WHERE DD.SRCE <> '03' AND DD.SRCE <> '05' AND DD.SRCE <> '06' AND
  DD.CLS <> '30' AND ((CC.YSRCE = '01' AND CC.YCSTE = 0 ) OR 
  (CC.YSRCE <> '01' AND CC.YCSTD = 0 ));

-- 통화단위 미등록
INSERT INTO PBBPM.BPM512
( CHGDATE,XYEAR,ERRGUBUN,
ERRMDNO,ERRITNO,ERRPLANT,ERRDIV,ERRVNDSR,ERRCUR,
ERRUNIT1,ERRUNIT2,ERRCHGE,ERRPLAN,ERRCONFIRM,UPDTID )
SELECT CHAR(CURRENT TIMESTAMP), BB.XYEAR,'통화단위 미등록 품목',
BB.BMDNO,BB.BCHNO,BB.BPLANT,BB.BDIV,CC.YVNDSR,CC.YCURR,
CC.XUNIT,CC.XUNIT1,CC.YCHGE,CC.YPLAN,'N',''
FROM (SELECT DISTINCT COMLTD,AYEAR,ACODE,AREV,APLANT,ADIV,APDCD,AMDNO,ADECD FROM PBBPM.BPM501
  WHERE COMLTD = '01' AND AYEAR = '2009' AND APLANT = 'D' AND 
    ADIV = 'A' AND ACODE = 'A' AND AREV = '0A' ) AA
INNER JOIN PBBPM.BPM508 BB
ON AA.COMLTD = BB.COMLTD AND AA.AYEAR = BB.XYEAR AND
  AA.APLANT = BB.BPLANT AND AA.ADIV = BB.BDIV AND
	AA.AMDNO = BB.BMDNO AND AA.ACODE = BB.BGUBUN AND AA.AREV = BB.BREV
INNER JOIN PBBPM.BPM503 DD
ON BB.XYEAR = DD.XYEAR AND BB.BPLANT = DD.XPLANT AND BB.BDIV = DD.DIV AND BB.BCHNO = DD.ITNO
INNER JOIN PBBPM.BPM509 CC
ON BB.BPLANT = CC.YPLANT AND BB.BDIV = CC.YDIV AND 
  BB.BCHNO = CC.YITNO AND BB.XYEAR = CC.YCCYY AND
  CC.YGRAD = '1'
WHERE CC.YCURR = '' OR CC.YCURR IS NULL;

-- 통화변환계수 미등록


