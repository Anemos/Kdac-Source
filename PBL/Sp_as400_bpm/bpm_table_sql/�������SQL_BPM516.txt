INSERT INTO PBBPM.BPM516
( comltd,xyear,wrev,wgubun,wplant,wdvsn,
witno,witem,wspec,wplan,wclss,wsrce,wpdcd,wbomum,wpurum,
wconv,wcode,wpay,wvdnm,wvdno,wvdkind,wcurr,wvhdkdtc,wvhdno5,
wcost,wcostw,wrcpcst,wcostyr,wcostbom,wrcpcstbom,wcostyrbom,wuse,
wqty1,wqty2,wqty3,wqty4,wqty5,wqty6,wqty7,wqty8,wqty9,wqty10,wqty11,wqty12,
wyou,wkanban,wcostold,wcostd0a )

SELECT KK.COMLTD,KK.XYEAR,KK.BREV,KK.BGUBUN,KK.BPLANT,KK.BDIV,
KK.BCHNO,FF.ITNM,FF.SPEC,CC.YPLAN,DD.CLS,DD.SRCE,DD.PDCD,CC.BOMUNIT,CC.XUNIT1,
CC.CONVINV,CC.YCHGE,
IFNULL(( SELECT COITNAME FROM PBCOMMON.DAC002 
  WHERE COMLTD = '01' AND COCODE = CC.YCODE AND COGUBUN = 'BPM050'),'X'),
IFNULL(GG.VNDNM,''),CC.YVNDSR,
IFNULL(CASE WHEN DD.SRCE = '01' THEN
    ( SELECT XKIND FROM PBPUR.PUR102 WHERE COMLTD = '01' AND DEPT = 'I' AND VSRNO = CC.YVNDSR )
  ELSE
    ( SELECT XKIND FROM PBPUR.PUR102 WHERE COMLTD = '01' AND DEPT = 'D' AND VSRNO = CC.YVNDSR )
  END,''),
CC.YCURR,
IFNULL(CASE WHEN DD.SRCE = '01' THEN
    ( SELECT EADJDT FROM PBPUR.PUR103 WHERE COMLTD = '01' AND DEPT = 'I' AND VSRC = 'I' AND VSRNO = CC.YVNDSR AND ITNO = KK.BCHNO)
  ELSE
    ( SELECT DADJDT FROM PBPUR.PUR103 WHERE COMLTD = '01' AND DEPT = 'D' AND VSRC = 'D' AND VSRNO = CC.YVNDSR AND ITNO = KK.BCHNO )
  END,''),
IFNULL(CASE WHEN DD.SRCE = '01' THEN
    ( SELECT ESHEET FROM PBPUR.PUR103 WHERE COMLTD = '01' AND DEPT = 'I' AND VSRC = 'I' AND VSRNO = CC.YVNDSR AND ITNO = KK.BCHNO )
  ELSE
    ( SELECT DSHEET FROM PBPUR.PUR103 WHERE COMLTD = '01' AND DEPT = 'D' AND VSRC = 'D' AND VSRNO = CC.YVNDSR AND ITNO = KK.BCHNO )
  END,''),
DECIMAL(CASE WHEN DD.CLS = '10' OR DD.CLS = '20' OR DD.CLS = '40' OR DD.CLS = '50' OR DD.CLS = '35' THEN
	CASE WHEN ( DD.SRCE = '03' OR DD.SRCE = '05' OR DD.SRCE = '06' ) OR DD.CLS = '30' THEN 0
   ELSE 
     CASE WHEN DD.SRCE <> '01' THEN 
       CC.YCSTD
     ELSE 
       CC.YCSTE
     END 
   END
ELSE 0 END,13,5) AS WCOST,
DECIMAL(CASE WHEN DD.CLS = '10' OR DD.CLS = '20' OR DD.CLS = '40' OR DD.CLS = '50' OR DD.CLS = '35' THEN
	CASE WHEN ( DD.SRCE = '03' OR DD.SRCE = '05' OR DD.SRCE = '06' ) OR DD.CLS = '30' THEN 0
   ELSE 
     CASE WHEN DD.SRCE <> '01' THEN 
       CC.YCSTD * IFNULL(( SELECT EXCH FROM PBBPM.BPM506 WHERE XYEAR = '2009' AND CURR = CC.YCURR ),1)
     ELSE 
       CC.YCSTE * IFNULL(( SELECT EXCH FROM PBBPM.BPM506 WHERE XYEAR = '2009' AND CURR = CC.YCURR ),1)
     END 
   END
ELSE 0 END,11,3) AS WCOSTW,
0,0,
DECIMAL(CASE WHEN DD.CLS = '10' OR DD.CLS = '20' OR DD.CLS = '40' OR DD.CLS = '50' OR DD.CLS = '35' THEN
	CASE WHEN ( DD.SRCE = '03' OR DD.SRCE = '05' OR DD.SRCE = '06' ) OR DD.CLS = '30' THEN 0
   ELSE 
     CASE WHEN DD.SRCE <> '01' THEN 
       CC.YCSTD / CC.CONVQTY * IFNULL(( SELECT EXCH FROM PBBPM.BPM506 WHERE XYEAR = '2009' AND CURR = CC.YCURR ),1)
     ELSE 
       CC.YCSTE / CC.CONVQTY * IFNULL(( SELECT EXCH FROM PBBPM.BPM506 WHERE XYEAR = '2009' AND CURR = CC.YCURR ),1)
     END 
   END
ELSE 0 END,11,3) AS WCOSTBOM,
0,0,'',
KK.QTY1,KK.QTY2,KK.QTY3,KK.QTY4,KK.QTY5,KK.QTY6,KK.QTY7,KK.QTY8,
KK.QTY9,KK.QTY10,KK.QTY11,KK.QTY12,
'','',0,0
FROM ( SELECT BB.COMLTD,BB.XYEAR,BB.BREV,BB.BGUBUN,BB.BPLANT,BB.BDIV,
BB.BCHNO,
SUM(AA.QTY1 * BB.BPRQT) AS QTY1,
SUM(AA.QTY2 * BB.BPRQT) AS QTY2,
SUM(AA.QTY3 * BB.BPRQT) AS QTY3,
SUM(AA.QTY4 * BB.BPRQT) AS QTY4,
SUM(AA.QTY5 * BB.BPRQT) AS QTY5,
SUM(AA.QTY6 * BB.BPRQT) AS QTY6,
SUM(AA.QTY7 * BB.BPRQT) AS QTY7,
SUM(AA.QTY8 * BB.BPRQT) AS QTY8,
SUM(AA.QTY9 * BB.BPRQT) AS QTY9,
SUM(AA.QTY10 * BB.BPRQT) AS QTY10,
SUM(AA.QTY11 * BB.BPRQT) AS QTY11,
SUM(AA.QTY12 * BB.BPRQT) AS QTY12
FROM ( SELECT COMLTD,AYEAR,AREV,ACODE,APLANT,ADIV,APDCD,AMDNO,SEQGB,SUM(ASQTY1) AS QTY1,
 SUM(ASQTY2) AS QTY2, SUM(ASQTY3) AS QTY3, SUM(ASQTY4) AS QTY4, SUM(ASQTY5) AS QTY5,
 SUM(ASQTY6) AS QTY6, SUM(ASQTY7) AS QTY7, SUM(ASQTY8) AS QTY8, SUM(ASQTY9) AS QTY9,
 SUM(ASQTY10) AS QTY10, SUM(ASQTY11) AS QTY11, SUM(ASQTY12) AS QTY12 FROM PBBPM.BPM501
WHERE COMLTD = '01' AND AYEAR = '2009' AND AREV = '0A' AND ACODE = 'A'
GROUP BY COMLTD,AYEAR,AREV,ACODE,APLANT,ADIV,APDCD,AMDNO,SEQGB ) AA
INNER JOIN PBBPM.BPM508 BB
ON AA.COMLTD = BB.COMLTD AND AA.APLANT = BB.BPLANT AND AA.ADIV = BB.BDIV AND
	AA.AMDNO = BB.BMDNO AND AA.AYEAR = BB.XYEAR AND AA.AREV = BB.BREV AND
	AA.ACODE = BB.BGUBUN
WHERE BB.BWOCT <> '8888' AND BB.BYOU <> '*' 
GROUP BY BB.COMLTD,BB.XYEAR,BB.BREV,BB.BGUBUN,BB.BPLANT,BB.BDIV,BB.BCHNO ) KK
INNER JOIN PBBPM.BPM503 DD
ON KK.XYEAR = DD.XYEAR AND KK.BPLANT = DD.XPLANT AND KK.BDIV = DD.DIV AND KK.BCHNO = DD.ITNO
INNER JOIN PBBPM.BPM502 FF
ON DD.XYEAR = FF.XYEAR AND DD.ITNO = FF.ITNO
INNER JOIN PBBPM.BPM509 CC
ON KK.XYEAR = CC.YCCYY AND KK.BCHNO = CC.YITNO AND
   CC.YGUBUN = '10' AND CC.YGRAD = '1'
LEFT OUTER JOIN PBBPM.BPM520 EE
ON CC.YCURR = EE.CURUNIT
LEFT OUTER JOIN PBPUR.PUR101 GG
ON CC.YVNDSR = GG.VSRNO AND GG.COMLTD = '01'
ORDER BY KK.BPLANT,KK.BDIV,KK.BCHNO
;

-- 품목별 오류체크
SELECT *
FROM PBBPM.BPMT24 A
WHERE WPLANT = 'D' AND WDVSN = 'A' AND 
NOT EXISTS ( SELECT * FROM PBBPM.BPM516 B
	WHERE A.COMLTD = B.COMLTD AND A.WPLANT = B.WPLANT AND A.WDVSN = B.WDVSN AND A.WITNO = B.WITNO );

//SELECT *
//FROM PBBPM.BPMT24 A
//WHERE WPLANT = 'D' AND WDVSN = 'A' AND 
//NOT EXISTS ( SELECT * FROM PBBPM.BPM516 B
//	WHERE A.COMLTD = B.COMLTD AND A.WPLANT = B.WPLANT AND A.WDVSN = B.WDVSN AND A.WITNO = B.WITNO );

SELECT A.WPLANT,A.WDVSN,A.WITNO,A.WCLSS,A.WSRCE,A.WCOST,A.WCOSTW,A.WCOSTBOM,B.WCOST,B.WCOSTW,B.WCOSTBOM
FROM PBBPM.BPMT24 A INNER JOIN PBBPM.BPM516 B
 ON A.COMLTD = B.COMLTD AND A.WPLANT = B.WPLANT AND
	A.WDVSN = B.WDVSN AND A.WITNO = B.WITNO AND A.WVDNO = B.WVDNO AND
	B.XYEAR = '2009' AND B.WREV = '0A' AND B.WGUBUN = 'A'
WHERE A.WCOST <> B.WCOST OR A.WCOSTW <> B.WCOSTW ;

//SELECT * FROM PBBPM.BPM509
//WHERE YITNO = '410209';

SELECT * FROM PBBPM.BPMT24
WHERE WITNO = '410209';
--외자
SELECT A.WPLANT,A.WDVSN,A.WITNO,B.YVNDSR,A.WCLSS,A.WSRCE,A.WCOST,B.YCSTE01,B.YCSTE0
FROM PBBPM.BPMT24 A INNER JOIN
( SELECT COMLTD,YPLANT,YDIV,YITNO,YVNDSR,YCCYY,YSRCE,
TRUNCATE(YCSTE0,4) AS YCSTE0,TRUNCATE(YCSTE01,4) AS YCSTE01 FROM PBBPM.BPM103
	WHERE YCCYY = '2009' AND YSRCE = '01' ) B
 ON A.COMLTD = B.COMLTD AND A.WPLANT = B.YPLANT AND
	A.WDVSN = B.YDIV AND A.WITNO = B.YITNO AND A.WVDNO = B.YVNDSR
WHERE A.WCOST <> B.YCSTE0 ;
--내자
SELECT A.WPLANT,A.WDVSN,A.WITNO,B.YVNDSR,A.WCLSS,A.WSRCE,A.WCOST,B.YCSTD01,B.YCSTD0
FROM PBBPM.BPMT24 A INNER JOIN
( SELECT COMLTD,YPLANT,YDIV,YITNO,YVNDSR,YCCYY,YSRCE,
TRUNCATE(YCSTD0,4) AS YCSTD0,TRUNCATE(YCSTD01,4) AS YCSTD01 FROM PBBPM.BPM103
	WHERE YCCYY = '2009' AND YSRCE <> '01' ) B
 ON A.COMLTD = B.COMLTD AND A.WPLANT = B.YPLANT AND
	A.WDVSN = B.YDIV AND A.WITNO = B.YITNO AND A.WVDNO = B.YVNDSR
WHERE A.WCOST <> B.YCSTD0 ;

SELECT A.WPLANT,A.WDVSN,A.WITNO,B.YVNDSR,A.WCLSS,A.WSRCE,A.WCOST,B.YCSTE1,B.YCSTR
FROM PBBPM.BPM516 A INNER JOIN
( SELECT YPLANT,YDIV,YITNO,YVNDSR,YCCYY,YSRCE,
TRUNCATE(YCSTR,4) AS YCSTR,TRUNCATE(YCSTE1,4) AS YCSTE1 FROM PBBPM.BPM509
	WHERE YCCYY = '2009' AND YSRCE = '01' AND YGRAD  = '1' AND YGUBUN = '10') B
 ON A.WPLANT = B.YPLANT AND
	A.WDVSN = B.YDIV AND A.WITNO = B.YITNO AND A.WVDNO = B.YVNDSR
WHERE A.WCOST <> B.YCSTR ;

SELECT A.WPLANT,A.WDVSN,A.WITNO,A.WCLSS,A.WSRCE,A.WCOST,A.WCOSTW,A.WCOSTBOM,B.WCOST,B.WCOSTW,B.WCOSTBOM
FROM PBBPM.BPMT24 A INNER JOIN PBBPM.BPM516 B
 ON A.COMLTD = B.COMLTD AND A.WPLANT = B.WPLANT AND
	A.WDVSN = B.WDVSN AND A.WITNO = B.WITNO AND A.WVDNO = B.WVDNO AND
	B.XYEAR = '2009' AND B.WREV = '0A' AND B.WGUBUN = 'A'
WHERE A.WCOST <> B.WCOST OR A.WCOSTW <> B.WCOSTW ;

-- 구품목존재 신품목 미존재
SELECT * FROM PBBPM.BPMT24 A
WHERE A.COMLTD = '01' AND 
NOT EXISTS ( SELECT * FROM PBBPM.BPM516 B
	WHERE A.COMLTD = B.COMLTD AND A.WPLANT = B.WPLANT AND
		A.WDVSN = B.WDVSN AND A.WITNO = B.WITNO AND
		B.XYEAR = '2009' AND B.WREV = '0A' AND B.WGUBUN = 'A' )
;
-- 신품목존재 구품목 미존재
SELECT * FROM PBBPM.BPM516 A
WHERE A.COMLTD = '01' AND A.XYEAR = '2009' AND A.WREV = '0A' AND A.WGUBUN = 'A' AND
NOT EXISTS ( SELECT * FROM PBBPM.BPMT24 B
	WHERE A.COMLTD = B.COMLTD AND A.WPLANT = B.WPLANT AND
		A.WDVSN = B.WDVSN AND A.WITNO = B.WITNO )
;