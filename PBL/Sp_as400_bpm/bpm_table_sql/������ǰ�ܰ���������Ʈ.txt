SELECT TMP.COMLTD,TMP.XYEAR,TMP.BREV,TMP.BGUBUN,TMP.BALCD,TMP.BALDIV,TMP.BPRNO,FF.CLS,FF.SRCE,
SUM( DECIMAL(CASE WHEN TMP.SRCE <> '01' THEN
				TMP.CURDCST * TMP.WKEXCD / TMP.CONV_FACTOR * TMP.BPRQT1
		ELSE 0 END,15,6) ) AS D_COST
FROM ( SELECT BB.COMLTD,BB.BREV,BB.BGUBUN,BB.XYEAR,BB.BALCD,BB.BALDIV,
BB.BPRNO,BB.BCHNO,DD.CLS,BB.BPRQT1,DD.SRCE,
CC.YCURR,CC.YCSTD1,CC.YCSTE1,
// 외자적용기준단가
CASE WHEN DD.CLS = '10' OR DD.CLS = '20' OR DD.CLS = '40' OR DD.CLS = '50' OR DD.CLS = '35' THEN
	CASE WHEN ( DD.SRCE = '03' OR DD.SRCE = '05' OR DD.SRCE = '06' ) OR DD.CLS = '30' THEN 0
   ELSE CASE WHEN DD.SRCE <> '01' THEN 
          CASE WHEN CC.YCSTE1 = 0 THEN CC.YCSTD1 ELSE CC.YCSTE1 END
        ELSE CC.YCSTE1 END 
   END
ELSE 0 END AS CURECST,
// 내자적용기준단가
CASE WHEN DD.CLS = '10' OR DD.CLS = '20' OR DD.CLS = '40' OR DD.CLS = '50' OR DD.CLS = '35' THEN
	CASE WHEN ( DD.SRCE = '03' OR DD.SRCE = '05' OR DD.SRCE = '06' ) OR DD.CLS = '30' THEN 0
   ELSE CASE WHEN DD.SRCE <> '01' THEN 
          CASE WHEN CC.YCSTD1 = 0 THEN CC.YCSTE1 ELSE CC.YCSTD1 END
        ELSE CC.YCSTD1 END 
   END
ELSE 0 END AS CURDCST,
// 변환계수
CC.CONVQTY AS CONV_FACTOR,
// 통화번호
IFNULL(EE.SEQNO,'99') AS CUR_SEQNO,
// 환율
CASE WHEN CC.YCURR <> '' AND CC.YCURR <> 'KRW' THEN
   ( SELECT IFNULL(EXCH,0) FROM PBBPM.BPM506 WHERE XYEAR = '2010' AND CURR = CC.YCURR )
ELSE 1 END AS WKEXCD
FROM ( SELECT DISTINCT GG.COMLTD,GG.XYEAR,GG.BREV,GG.BGUBUN,GG.BALCD,GG.BALDIV,GG.BPRNO,GG.BCHNO,GG.BPRQT1
FROM PBBPM.BPM508 GG
WHERE GG.COMLTD = '01' AND GG.XYEAR = '2010' AND GG.BREV = '0A' AND GG.BGUBUN = 'A' AND GG.BWOCT = '8888') BB
INNER JOIN PBBPM.BPM503 DD
ON BB.XYEAR = DD.XYEAR AND BB.BALCD = DD.XPLANT AND BB.BALDIV = DD.DIV AND BB.BCHNO = DD.ITNO
INNER JOIN PBBPM.BPM509 CC
ON BB.XYEAR = CC.YCCYY AND BB.BCHNO = CC.YITNO AND
   CC.YGUBUN = '10' AND CC.YGRAD = '1'
LEFT OUTER JOIN PBBPM.BPM520 EE
ON CC.YCURR = EE.CURUNIT ) TMP
INNER JOIN PBBPM.BPM503 FF
ON TMP.XYEAR = FF.XYEAR AND TMP.BALCD = FF.XPLANT AND TMP.BALDIV = FF.DIV AND TMP.BPRNO = FF.ITNO
GROUP BY TMP.COMLTD,TMP.XYEAR,TMP.BREV,TMP.BGUBUN,TMP.BALCD,TMP.BALDIV,TMP.BPRNO,FF.CLS,FF.SRCE
ORDER BY TMP.COMLTD,TMP.XYEAR,TMP.BREV,TMP.BGUBUN,TMP.BALCD,TMP.BALDIV,TMP.BPRNO,FF.CLS,FF.SRCE;