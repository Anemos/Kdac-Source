CREATE TRIGGER PBIPIS.T_PUR103AU
   AFTER UPDATE ON PBPUR.PUR103
   REFERENCING NEW ROW AS NR
               OLD ROW AS OR
   FOR EACH ROW
   MODE DB2SQL
WHEN
   (NR.DADJDT <> OR.DADJDT OR NR.DCOST <> OR.DCOST OR
    NR.XSTOP  <> OR.XSTOP OR NR.ECOST <> OR.ECOST)
BEGIN
  DECLARE L_N_COUNT INTEGER DEFAULT 0 ;
  IF NR.DEPT = 'D' OR NR.DEPT = 'Y' THEN
    INSERT INTO PBIPIS.PDPUR103 (CHGDATE, CHGCD, COMLTD, VSRC, DEPT, VSRNO,
      ITNO, DADJDT, DCOST, EADJDT, ECOST, XSTOP, STSCD,   DOWNDATE)
    VALUES (CHAR(CURRENT TIMESTAMP), 'R', NR.COMLTD, NR.VSRC, NR.DEPT,
      NR.VSRNO, NR.ITNO, NR.DADJDT, NR.DCOST, NR.EADJDT, NR.ECOST, NR.XSTOP,
      'N', ' ') ;
  ELSEIF NR.DEPT = 'I' THEN
    INSERT INTO PBIPIS.PDPUR103 (CHGDATE, CHGCD, COMLTD, VSRC, DEPT, VSRNO,
      ITNO, DADJDT, DCOST, EADJDT, ECOST, XSTOP, STSCD,   DOWNDATE)
    VALUES (CHAR(CURRENT TIMESTAMP), 'R', NR.COMLTD, NR.VSRC, NR.DEPT,
      NR.VSRNO, NR.ITNO, NR.DADJDT, NR.DCOST, NR.EADJDT, NR.ECOST, NR.XSTOP,
      'N', ' ') ;
  ELSE
    SELECT COUNT(*) INTO L_N_COUNT FROM PBPUR.PUR103
      WHERE COMLTD = '01' AND VSRC = 'D' AND DEPT = 'D' AND
            ITNO = NR.ITNO and vsrno = nr.vsrno ;
    IF L_N_COUNT = 0 THEN
      INSERT INTO PBIPIS.PDPUR103 (CHGDATE, CHGCD, COMLTD, VSRC, DEPT, VSRNO,
        ITNO, DADJDT, DCOST, EADJDT, ECOST, XSTOP, STSCD,   DOWNDATE)
      VALUES (CHAR(CURRENT TIMESTAMP), 'R', NR.COMLTD, NR.VSRC, NR.DEPT,
        NR.VSRNO, NR.ITNO, NR.DADJDT, NR.DCOST, NR.EADJDT, NR.ECOST, NR.XSTOP,
        'N', ' ') ;
     END IF;
  END IF;
END

