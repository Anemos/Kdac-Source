CREATE TRIGGER PBIPIS.T_PUR103AD
   AFTER DELETE ON PBPUR.PUR103
   REFERENCING OLD ROW AS OR
   FOR EACH ROW
   MODE DB2SQL
BEGIN
  DECLARE L_N_COUNT INTEGER DEFAULT 0 ;
  DECLARE L_S_DEPT CHAR ;
  IF OR.DEPT = 'D' THEN
    SELECT COUNT(*) INTO L_N_COUNT FROM PBPUR.PUR103
      WHERE COMLTD = '01' AND VSRC = 'D' AND DEPT IN ('P','Y') AND
            ITNO = OR.ITNO and vsrno = or.vsrno ;
    IF L_N_COUNT = 0 THEN
      INSERT INTO PBIPIS.PDPUR103 (CHGDATE, CHGCD, COMLTD, VSRC, DEPT, VSRNO,
        ITNO, DADJDT, DCOST, EADJDT, ECOST, XSTOP, STSCD,   DOWNDATE)
      VALUES (CHAR(CURRENT TIMESTAMP), 'D', OR.COMLTD, OR.VSRC, OR.DEPT,
        OR.VSRNO, OR.ITNO, OR.DADJDT, OR.DCOST, OR.EADJDT, OR.ECOST, OR.XSTOP,
        'N', ' ') ;
    END IF;
  END IF;
  IF OR.DEPT = 'P' THEN
    SELECT COUNT(*) INTO L_N_COUNT FROM PBPUR.PUR103
         WHERE COMLTD = '01' AND VSRC = 'D' AND DEPT IN ('D','Y') AND
               ITNO = OR.ITNO and vsrno = or.vsrno ;
    IF L_N_COUNT = 0 THEN
      INSERT INTO PBIPIS.PDPUR103 (CHGDATE, CHGCD, COMLTD, VSRC, DEPT, VSRNO,
        ITNO, DADJDT, DCOST, EADJDT, ECOST, XSTOP, STSCD,   DOWNDATE)
      VALUES (CHAR(CURRENT TIMESTAMP), 'D', OR.COMLTD, OR.VSRC, OR.DEPT,
        OR.VSRNO, OR.ITNO, OR.DADJDT, OR.DCOST, OR.EADJDT, OR.ECOST, OR.XSTOP,
        'N', ' ') ;
    END IF;
  END IF;
  IF OR.DEPT = 'Y' THEN
    SELECT COUNT(*) INTO L_N_COUNT FROM PBPUR.PUR103
      WHERE COMLTD = '01' AND VSRC = 'D' AND DEPT IN ('D','P') AND
            ITNO = OR.ITNO and vsrno = or.vsrno ;
    IF L_N_COUNT = 0 THEN
      INSERT INTO PBIPIS.PDPUR103 (CHGDATE, CHGCD, COMLTD, VSRC, DEPT, VSRNO,
        ITNO, DADJDT, DCOST, EADJDT, ECOST, XSTOP, STSCD,   DOWNDATE)
      VALUES (CHAR(CURRENT TIMESTAMP), 'D', OR.COMLTD, OR.VSRC, OR.DEPT,
        OR.VSRNO, OR.ITNO, OR.DADJDT, OR.DCOST, OR.EADJDT, OR.ECOST, OR.XSTOP,
        'N', ' ') ;
    END IF;
  END IF;
  IF OR.DEPT = 'I' THEN
    INSERT INTO PBIPIS.PDPUR103 (CHGDATE, CHGCD, COMLTD, VSRC, DEPT, VSRNO,
      ITNO, DADJDT, DCOST, EADJDT, ECOST, XSTOP, STSCD,   DOWNDATE)
    VALUES (CHAR(CURRENT TIMESTAMP), 'D', OR.COMLTD, OR.VSRC, OR.DEPT,
      OR.VSRNO, OR.ITNO, OR.DADJDT, OR.DCOST, OR.EADJDT, OR.ECOST, OR.XSTOP,
      'N', ' ') ;
  END IF;
END

