--  Generate SQL
--  Version:                    V5R3M0 040528
--  Generated on:               09/06/22 12:01:56
--  Relational Database:        I520
--  Standards Option:           DB2 UDB iSeries
--  Description :               원단위DB For 조회
DROP TABLE PBPDM.BOMT13;

CREATE TABLE PBPDM.BOMT13 (
  ZCMCD CHAR(2) CCSID 833 NOT NULL DEFAULT '' ,       -- 회사
  ZDATE CHAR(6) CCSID 833 NOT NULL DEFAULT '' ,       -- 년월
  ZPLANT CHAR(1) CCSID 833 NOT NULL DEFAULT '' ,      -- 지역
  ZDIV CHAR(1) CCSID 833 NOT NULL DEFAULT '' ,        -- 공장
  ZMDCD VARCHAR(4) CCSID 833 NOT NULL DEFAULT '' ,    -- 제품군
  ZMDNO VARCHAR(12) CCSID 833 NOT NULL DEFAULT '' ,      -- 완제품
  ZSERIAL NUMERIC(4,0) NOT NULL DEFAULT 0 ,          -- SERIAL NO
  ZLEVEL VARCHAR(10) CCSID 833 NOT NULL DEFAULT '' ,  -- BOM LEVEL
  ZPITNO VARCHAR(12) CCSID 833 NOT NULL DEFAULT '' ,  -- 상위품번
  ZITNO VARCHAR(12) CCSID 833 NOT NULL DEFAULT '' ,      -- 품번
  ZREV CHAR(2) CCSID 833 NOT NULL DEFAULT '' ,        -- REV NO
  ZDESC VARCHAR(50) CCSID 933 NOT NULL DEFAULT '' ,      -- 품명
  ZSPEC VARCHAR(50) CCSID 933 NOT NULL DEFAULT '' ,      -- 규격
  ZUNIT1 CHAR(2) CCSID 833 NOT NULL DEFAULT '' ,      -- BOM단위
  ZUNITQTY DECIMAL(8,3) NOT NULL DEFAULT 0.000 ,   -- 원단위량
  ZCVTFACT DECIMAL(13,4) NOT NULL DEFAULT 0.0000 ,   -- 변환계수
  ZUNIT2 CHAR(2) CCSID 833 NOT NULL DEFAULT '' ,      -- 자재단위
  ZSRCE CHAR(2) CCSID 833 NOT NULL DEFAULT '' ,       -- 구입선
  ZABCCODE CHAR(1) CCSID 833 NOT NULL DEFAULT '' ,    -- ABC CODE
  ZISSCODE CHAR(1) CCSID 833 NOT NULL DEFAULT '' ,    -- 불출코드
  ZWHLCODE VARCHAR(6) CCSID 833 NOT NULL DEFAULT '' ,    -- 창고코드
  ZLOTSIZE DECIMAL(11,1) NOT NULL DEFAULT 0.0 ,    -- LOT SIZE
  ZLEADTIME DECIMAL(3,0) NOT NULL DEFAULT 0 ,   -- LEAD TIME
  ZMOVCOST DECIMAL(15,6) NOT NULL DEFAULT 0.000000 ,   -- 이동평균단가
  ZRCPCOST DECIMAL(15,6) NOT NULL DEFAULT 0.000000 ,   -- 최종입고단가
  ZOUTCOST DECIMAL(15,6) NOT NULL DEFAULT 0.000000 ,   -- 불출평균단가
  ZWKCT CHAR(4) CCSID 833 NOT NULL DEFAULT '' ,       -- 조코드
  ZGRAD CHAR(1) CCSID 833 NOT NULL DEFAULT '' ,       -- 호환여부
  ZALTNO VARCHAR(12) CCSID 833 NOT NULL DEFAULT '' ,     -- 호환품번
  ZFMDT CHAR(8) CCSID 833 NOT NULL DEFAULT '' ,       -- 적용시작일
  ZTODT CHAR(8) CCSID 833 NOT NULL DEFAULT '' ,       -- 적용완료일
  ZCALC CHAR(1) CCSID 833 NOT NULL DEFAULT '' ,       -- 재료비 계산여부
  ZCOMCD CHAR(1) CCSID 833 NOT NULL DEFAULT '' ,      -- 고객사유상 대상여부
  ZYGCHK CHAR(1) CCSID 833 NOT NULL DEFAULT '' ,      -- 사급완성품여부
  ZYGCST DECIMAL(15,6) NOT NULL DEFAULT 0.000000 ,    -- 가공관리비
  ZSUBPAYCD CHAR(1) CCSID 833 NOT NULL DEFAULT '',    -- 협력업체 유상제품여부
  ZDAMDANG CHAR(2) CCSID 833 NOT NULL DEFAULT '',     -- 구매담당
  ZPRUNT CHAR(2) CCSID 833 NOT NULL DEFAULT '',       -- 외자단위
  ZPTOD CHAR(2) CCSID 833 NOT NULL DEFAULT '',        -- 인도조건
  ZPCURR CHAR(3) CCSID 833 NOT NULL DEFAULT '',       -- 통화단위
  ZPTOTDAN DECIMAL(15,4) NOT NULL DEFAULT 0.0000,   -- 통합단가
  ZPRUTC DECIMAL(15,4) NOT NULL DEFAULT 0.0000,     -- 외자단가
  ZPVSRNO VARCHAR(8) CCSID 833 NOT NULL DEFAULT '',   -- 외자업체코드
  ZPVEND VARCHAR(50) CCSID 933 NOT NULL DEFAULT '',    -- 업체명
  PRIMARY KEY( ZCMCD , ZDATE , ZPLANT , ZDIV , ZMDCD , ZMDNO , ZSERIAL ) ) ;

CREATE INDEX PBPDM.BOMT13LX01
  ON PBPDM.BOMT13 ( ZCMCD ASC , ZDATE DESC , ZPLANT ASC , ZDIV ASC , ZPITNO ASC , ZITNO ASC ) ;

-- 추가요청 칼럼
-- 외자 정보 OPM102 XCOST:발주단가, XUNIT1:구매단위, PURNO:발주번호, SRNO:발주개정번호
--           OPM101 CURR:통화단위, TOD:인도조건, VSRNO1:제조업체

-- 에러 검증작업
SELECT A.ZPLANT,A.ZDIV,A.ZMDNO,A.A_CNT,B.B_CNT,A.MOVCOST,B.MOVCOST,A.RCPCOST,B.RCPCOST
FROM ( SELECT ZPLANT,ZDIV,ZMDNO,COUNT(*) AS A_CNT,
SUM(CAST( CASE WHEN ZMOVCOST = '' THEN '0' ELSE REPLACE(ZMOVCOST,',','') END AS DECIMAL(15,6))) AS MOVCOST,
SUM(CAST( CASE WHEN ZRCPCOST = '' THEN '0' ELSE REPLACE(ZRCPCOST,',','') END AS DECIMAL(15,6))) AS RCPCOST
FROM PBPDM.BOM013 WHERE ZCMCD = '01' AND ZPLANT = 'D' AND ZDIV = 'A' AND ZDATE = '200906'
GROUP BY ZPLANT,ZDIV,ZMDNO ) A,
( SELECT ZPLANT,ZDIV,ZMDNO,COUNT(*) AS B_CNT,SUM(ZMOVCOST) AS MOVCOST,SUM(ZRCPCOST) AS RCPCOST
FROM PBPDM.BOMT13 WHERE ZCMCD = '01' AND ZPLANT = 'D' AND ZDIV = 'A' AND ZDATE = '200906'
GROUP BY ZPLANT,ZDIV,ZMDNO ) B
WHERE A.ZPLANT = B.ZPLANT AND A.ZDIV = B.ZDIV AND A.ZMDNO = B.ZMDNO AND
( A.A_CNT <> B.B_CNT OR A.MOVCOST <> B.MOVCOST OR A.RCPCOST <> B.RCPCOST );

SELECT 'AA',zcmcd,zdate,zplant,zdiv,zmdcd,zmdno,
    zserial,zlevel,zitno,CAST( CASE WHEN ZMOVCOST = '' THEN '0' ELSE REPLACE(ZMOVCOST,',','') END AS DECIMAL(15,6)) AS MOVCOST,
CAST( CASE WHEN ZRCPCOST = '' THEN '0' ELSE REPLACE(ZRCPCOST,',','') END AS DECIMAL(15,6)) AS RCPCOST
FROM PBPDM.BOM013 WHERE ZCMCD = '01' AND ZDATE = '200906' AND ZPLANT = 'D' AND ZDIV = 'H' AND
ZMDNO = '620975'
UNION ALL
SELECT 'BB',zcmcd,zdate,zplant,zdiv,zmdcd,zmdno,
    zserial,zlevel,zitno,ZMOVCOST,ZRCPCOST
FROM PBPDM.BOMT13 WHERE ZCMCD = '01' AND ZDATE = '200906' AND ZPLANT = 'D' AND ZDIV = 'H' AND
ZMDNO = '620975'
ORDER BY ZITNO;

SELECT A.ZPLANT,A.ZDIV,A.ZMDNO,A.A_CNT
FROM ( SELECT ZPLANT,ZDIV,ZMDNO,COUNT(*) AS A_CNT,
SUM(CAST( CASE WHEN ZMOVCOST = '' THEN '0' ELSE REPLACE(ZMOVCOST,',','') END AS DECIMAL(15,6))) AS MOVCOST,
SUM(CAST( CASE WHEN ZRCPCOST = '' THEN '0' ELSE REPLACE(ZRCPCOST,',','') END AS DECIMAL(15,6))) AS RCPCOST
FROM PBPDM.BOM013 WHERE ZCMCD = '01' AND ZDATE = '200907'
GROUP BY ZPLANT,ZDIV,ZMDNO ) A
WHERE NOT EXISTS ( SELECT * FROM
    ( SELECT ZPLANT,ZDIV,ZMDNO,COUNT(*) AS B_CNT,SUM(ZMOVCOST) AS MOVCOST,SUM(ZRCPCOST) AS RCPCOST
    FROM PBPDM.BOMT13 WHERE ZCMCD = '01' AND ZDATE = '200907'
    GROUP BY ZPLANT,ZDIV,ZMDNO ) B
    WHERE A.ZPLANT = B.ZPLANT AND A.ZDIV = B.ZDIV AND A.ZMDNO = B.ZMDNO );